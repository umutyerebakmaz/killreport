# âœ… Backfill System - Ready for Production

## ğŸ“¦ New Files Created

### Queue Scripts

- âœ… **`backend/queue-character-killmails.ts`**
  - Adds character IDs to backfill queue
  - Usage: `yarn queue:character-killmails <characterId>`

### Worker Scripts

- âœ… **`backend/worker-backfill-zkillboard.ts`**
  - Fetches historical killmails
  - Rate limited: 10-second delay
  - Processes zkillboard_backfill_queue

### Helper Files

- âœ… **`backend/src/services/zkillboardBackfillService.ts`**
  - Core logic
  - Pagination support
  - Duplicate detection
  - error handling

---

## ğŸ¯ How to Use

### Manual Backfill (Single Character)

```bash
cd backend
yarn queue:character-killmails 2117325769  # Killman Blu character ID
```

### Automatic Backfill (Via GraphQL Mutation)

```graphql
mutation {
  startKillmailBackfill(
    input: {
      characterId: 2117325769
      options: {
        fromDate: "2023-01-01"
        maxPages: 10
      }
    }
  ) {
    success
    message
    queuedAt
  }
}
```

### Tracking Worker

```bash
cd backend
yarn worker:backfill
```

PM2 setup:

```bash
pm2 start ecosystem.config.js --only worker-backfill
pm2 logs worker-backfill
```

---

## ğŸ“Š What Gets Backfilled

When backfilling character killmails:

1. âœ… Killmail itself (`Killmail` table)
2. âœ… Victim information
3. âœ… Attackers (all entities)
4. âœ… Victim items (if destroyed)
5. âœ… Related entities added to enrichment queue:
   - Characters â†’ `esi_character_info_queue`
   - Corporations â†’ `esi_corporation_info_queue`
   - Alliances â†’ `esi_alliance_info_queue`
   - Ships/Items â†’ `esi_type_info_queue`

### What Gets Enriched Afterward

- Character names, corps, alliances
- Corporation info (ticker, CEO, etc.)
- Alliance info (ticker, executor, etc.)
- Ship/module names and details

---

## ğŸ›ï¸ Advanced Options

### Available Options

```typescript
interface BackfillOptions {
  fromDate?: string;      // "2023-01-01" (only this date and after)
  maxPages?: number;      // 10 (max 10 pages = 1000 killmails)
  limit?: number;         // 100 (killmails per page, max 200)
  skipExisting?: boolean; // Default: true (skip duplicates)
}
```

### Example GraphQL Query

```graphql
mutation {
  startKillmailBackfill(
    input: {
      characterId: 2117325769
      options: {
        fromDate: "2024-01-01"
        maxPages: 5
        limit: 200
      }
    }
  ) {
    success
    message
  }
}
```

---

## ğŸ“ˆ Performance Metrics

### Processing Time

- **zKillboard API delay:** 10 seconds/page
- **1 page (100 killmails):** ~10 seconds
- **10 pages (1000 killmails):** ~1 minute 40 seconds

### Limits

- **Max killmails per page:** 200 (zKillboard limit)
- **Typical per page:** 100 (default)
- **Max in 1 backfill:** No limit (processes until no data left)

---

## ğŸ§ª Test Status

Tested on production:

- âœ… Killman Blu (2117325769) - 3 pages (~300 killmails)
- âœ… Entity enrichment working (characters, corps, alliances)
- âœ… No duplicates

---

## ğŸ”„ Integration with Existing System

### Compatible with Existing Workers

- âœ… `worker-zkillboard` (old system, still working)
  - Runs per killmail
  - Uses different queue: `zkillboard_character_queue`

- âœ… `worker-backfill` (new system)
  - Processes pages in batches
  - Uses different queue: `zkillboard_backfill_queue`

Both can run simultaneously.

### Queue Names

| Worker                 | Queue Name                  | Purpose      |
| ---------------------- | --------------------------- | ------------ |
| worker-zkillboard      | zkillboard_character_queue  | Old system   |
| worker-backfill        | zkillboard_backfill_queue   | New system   |

---

## ğŸ›¡ï¸ Safety

### Rate Limiting

- âœ… 10-second delay (zKillboard rules)
- âœ… No excessive requests

### Duplicate Detection

- âœ… Checks `killmail_id + killmail_hash`
- âœ… Skips if already in database
- âœ… No duplicate data

### Error Handling

- âœ… Graceful failure (no crashes)
- âœ… Error logging
- âœ… Automatic retry (RabbitMQ `requeue`)

---

## ğŸš€ Production Readiness

| Feature               | Status |
| --------------------- | ------ |
| Rate limiting         | âœ…     |
| Duplicate prevention  | âœ…     |
| Entity enrichment     | âœ…     |
| Error handling        | âœ…     |
| Logging               | âœ…     |
| GraphQL integration   | âœ…     |
| PM2 support           | âœ…     |
| Tested in production  | âœ…     |

---

## ğŸ“š Documentation

- **Queue Usage Guide:** [QUEUE_BACKFILL_GUIDE.MD](./QUEUE_BACKFILL_GUIDE.MD)
- **Full Value Backfill:** [BACKFILL_VALUES_GUIDE.MD](./BACKFILL_VALUES_GUIDE.MD)

---

**Status:** âœ… Ready for production use
**Last Updated:** January 8, 2026
