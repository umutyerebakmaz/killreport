server {
    server_name api.killreport.com;

    # Client body size (GraphQL mutations için)
    client_max_body_size 10M;

    # SSE için global ayarlar - buffering tamamen kapat
    proxy_buffering off;
    proxy_cache off;

    # Gzip'i tamamen devre dışı bırak (SSE için kritik!)
    gzip off;

    # GraphQL endpoint (SSE subscription desteği ile)
    location /graphql {
        proxy_pass http://localhost:4000/graphql;
        proxy_http_version 1.1;

        # SSE (Server-Sent Events) için kritik ayarlar
        proxy_set_header Connection '';
        proxy_set_header Cache-Control 'no-cache';
        proxy_set_header X-Accel-Buffering 'no';

        # Response buffering devre dışı
        proxy_request_buffering off;

        # Backend'e encoding isteği gönderme
        proxy_set_header Accept-Encoding "";

        # Chunked transfer encoding (SSE için)
        chunked_transfer_encoding on;

        # WebSocket support (legacy/fallback)
        proxy_set_header Upgrade $http_upgrade;

        # CORS is handled by GraphQL Yoga - don't override here!
        # This allows backend to control CORS based on environment

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout'ları artır (SSE connection'lar uzun süreli)
        proxy_connect_timeout 300s;
        proxy_send_timeout 86400s;    # 24 saat
        proxy_read_timeout 86400s;    # 24 saat
    }

    # EVE SSO callback
    location /auth {
        proxy_pass http://localhost:4000/auth;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # RabbitMQ Management UI
    location /rabbitmq/ {
        # RabbitMQ management plugin 15672 portunda çalışır
        proxy_pass http://localhost:15672/;
        proxy_http_version 1.1;

        # Buffering ayarları
        proxy_buffering off;
        proxy_request_buffering off;

        # WebSocket support (RabbitMQ UI için gerekli)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Standard proxy headers - Host için $http_host kullan
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout'lar
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # OPTIONAL: IP whitelist (güvenlik için)
        # allow YOUR_HOME_IP;
        # deny all;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/api.killreport.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/api.killreport.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = api.killreport.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name api.killreport.com;
    return 404; # managed by Certbot
}
