# Query Optimization Deployment Guide

## ğŸ“‹ Deployment Ã–zeti

Bu deployment, PostgreSQL query parameter limit hatasÄ±nÄ± Ã§Ã¶zer ve bÃ¼yÃ¼k result setlerle (Ã¶zellikle alliance filtreleri) performansÄ± optimize eder.

**Deployment Tarihi:** 15 Åubat 2026
**Ã–nem Seviyesi:** YÃ¼ksek - Kritik hata dÃ¼zeltmesi
**Downtime:** HayÄ±r
**Database DeÄŸiÅŸiklikleri:** Evet (Materialized View)

---

## ğŸ”§ YapÄ±lan DeÄŸiÅŸiklikler

### 1. Backend Code DeÄŸiÅŸiklikleri

**`backend/src/resolvers/killmail/queries.ts`**

- âœ… Entity filtreleri (alliance, corporation, character, ship) iÃ§in raw SQL kullanÄ±mÄ±
- âœ… PostgreSQL `ANY()` syntax ile array parameter handling
- âœ… Parameter limit hatalarÄ±nÄ±n ortadan kaldÄ±rÄ±lmasÄ±
- âœ… Count query optimizasyonu (kilmailIds.length kullanÄ±mÄ±)

### 2. Database DeÄŸiÅŸiklikleri

**Yeni Migration:** `20260215010000_add_killmail_filters_materialized_view`

**Materialized View Ã–zellikleri:**

- âœ… Pre-computed killmail filter data
- âœ… 13 optimized index (GIN indexes for arrays)
- âœ… CONCURRENTLY refresh support
- âœ… No JOIN queries needed

---

## ğŸš€ Production Deployment AdÄ±mlarÄ±

### Step 1: Kod Deployment

```bash
# Git pull ile gÃ¼ncel kodu Ã§ek
cd /root/killreport
git pull origin main

# Backend dependencies check
cd backend
npm install

# Build TypeScript
npm run build
```

### Step 2: Database Migration

**âš ï¸ Ã–NEMLÄ°:** Materialized view oluÅŸturma ~30-60 saniye sÃ¼rebilir (1M+ killmail iÃ§in)

```bash
# Prisma migration Ã§alÄ±ÅŸtÄ±r
cd /root/killreport/backend
npx prisma migrate deploy
```

Migration ÅŸunlarÄ± yapacak:

- `killmail_filters_mv` materialized view oluÅŸturur
- 13 adet optimized index oluÅŸturur (GIN indexes included)
- TÃ¼m killmail datayÄ± pre-compute eder

### Step 3: Materialized View'Ä± Kontrol Et

**Navicat SQL Console'da Ã§alÄ±ÅŸtÄ±r (Copy-Paste Ready):**

```sql
-- 1. Materialized view var mÄ± kontrol et
SELECT EXISTS (
  SELECT FROM pg_matviews WHERE matviewname = 'killmail_filters_mv'
) as exists;
```

Beklenen: `exists = true` (veya `t`)

```sql
-- 2. KaÃ§ kayÄ±t var kontrol et
SELECT COUNT(*) as total_records FROM killmail_filters_mv;
```

Beklenen: `total_records > 0` (Ã¶rnek: 150000)

```sql
-- 3. View boyutunu kontrol et
SELECT pg_size_pretty(pg_total_relation_size('killmail_filters_mv')) as view_size;
```

Beklenen: `view_size` Ã¶rnek: "45 MB"

```sql
-- 4. Ä°ndexleri kontrol et (13 index olmalÄ±)
SELECT
  indexname,
  indexdef
FROM pg_indexes
WHERE tablename = 'killmail_filters_mv'
ORDER BY indexname;
```

Beklenen: 13 satÄ±r dÃ¶ndÃ¼ (tÃ¼m indexler oluÅŸturulmuÅŸ)

### Step 4: Backend Restart

```bash
# PM2 ile backend'i restart et
pm2 restart backend

# LoglarÄ± kontrol et
pm2 logs backend --lines 50
```

### Step 5: Test Alliance Query

```bash
# GraphQL query test et
curl -X POST https://api.killreport.com/graphql \
  -H "Content-Type: application/json" \
  -d '{
    "query": "query { killmails(filter: { allianceId: 99000006, page: 1, limit: 25 }) { items { id killmailTime } pageInfo { totalCount } } }"
  }'
```

Beklenen:

- âœ… Hata yok
- âœ… Results dÃ¶ndÃ¼
- âœ… `totalCount` mevcut
- âœ… Response time < 2 saniye

---

## ğŸ” Monitoring ve Verification

### 1. PM2 Logs

```bash
# Backend loglarÄ±nÄ± izle
pm2 logs backend --lines 100

# ÅunlarÄ± ara:
# âœ… "ğŸ¯ Using Materialized View strategy for entity filters"
# âœ… "âœ… Materialized View returned X killmail IDs"
# âŒ "The query parameter limit supported by your database is exceeded"
```

### 2. PostgreSQL Performance Monitoring

**Navicat SQL Console'da Ã§alÄ±ÅŸtÄ±r:**

```sql
-- Materialized view boyutu
SELECT pg_size_pretty(pg_total_relation_size('killmail_filters_mv')) as view_size;
```

```sql
-- Index kullanÄ±m istatistikleri
SELECT
  schemaname,
  tablename,
  indexname,
  idx_scan as scans,
  pg_size_pretty(pg_relation_size(indexrelid)) as size
FROM pg_stat_user_indexes
WHERE tablename = 'killmail_filters_mv'
ORDER BY idx_scan DESC;
```

```sql
-- Materialized view vs killmails table karÅŸÄ±laÅŸtÄ±rma
SELECT
  'killmail_filters_mv' as object,
  COUNT(*) as record_count,
  pg_size_pretty(pg_total_relation_size('killmail_filters_mv')) as total_size
FROM killmail_filters_mv
UNION ALL
SELECT
  'killmails' as object,
  COUNT(*) as record_count,
  pg_size_pretty(pg_total_relation_size('killmails')) as total_size
FROM killmails;
```

### 3. Query Performance Test

Production'da GraphQL Playground kullanarak test:

```graphql
# Test 1: Alliance filter (bÃ¼yÃ¼k alliance)
query TestAllianceFilter {
  killmails(filter: { allianceId: 99000006, page: 1, limit: 25 }) {
    items {
      id
      killmailTime
      attackerCount
    }
    pageInfo {
      totalCount
      totalPages
      hasNextPage
    }
  }
}

# Test 2: Multiple filters
query TestMultipleFilters {
  killmails(
    filter: {
      allianceId: 99000006
      regionId: 10000002
      minAttackers: 10
      page: 1
      limit: 25
    }
  ) {
    items {
      id
      killmailTime
    }
    pageInfo {
      totalCount
    }
  }
}
```

---

## ğŸ”„ Materialized View Refresh Schedule

Materialized view otomatik olarak her 5 dakikada bir refresh edilir (scheduler zaten Ã§alÄ±ÅŸÄ±yor).

**Manuel refresh gerekirse (Navicat SQL Console'da Ã§alÄ±ÅŸtÄ±r):**

```sql
-- CONCURRENTLY: View kullanÄ±mda kalabilir, queries bloklanmaz
REFRESH MATERIALIZED VIEW CONCURRENTLY killmail_filters_mv;
```

**Refresh durumunu kontrol et:**

```sql
-- KaÃ§ yeni killmail eklendi (refresh gerekli mi?)
SELECT
  (SELECT COUNT(*) FROM killmails) - (SELECT COUNT(*) FROM killmail_filters_mv) as difference;
```

EÄŸer `difference > 100` ise refresh yapÄ±lmalÄ±.

---

## âš ï¸ Potansiyel Sorunlar ve Ã‡Ã¶zÃ¼mler

### Problem 1: Migration uzun sÃ¼rÃ¼yor

**Sebep:** BÃ¼yÃ¼k killmail dataset (>1M records)

**Ã‡Ã¶zÃ¼m:**

1. Migration'Ä± sakin saatlerde Ã§alÄ±ÅŸtÄ±r (gece/hafta sonu)
2. Migration timeout yoktur, bekle
3. **Navicat SQL Console'da** progress kontrol et:

```sql
-- Migration Ã§alÄ±ÅŸÄ±yor mu kontrol et
SELECT
  pid,
  now() - query_start as duration,
  state,
  query
FROM pg_stat_activity
WHERE query LIKE '%killmail_filters_mv%';
```

### Problem 2: Materialized view boÅŸ

**Sebep:** Migration hatalÄ± veya tamamlanmadÄ±

**Ã‡Ã¶zÃ¼m: Navicat'te migration SQL'ini manuel Ã§alÄ±ÅŸtÄ±r**

1. Backend sunucusunda migration dosyasÄ±nÄ± oku:

```bash
cat backend/prisma/migrations/20260215010000_add_killmail_filters_materialized_view/migration.sql
```

2. Ã‡Ä±kan SQL'i tamamen kopyala ve Navicat SQL Console'a yapÄ±ÅŸtÄ±r
3. TÃ¼m SQL'i seÃ§ ve Ã§alÄ±ÅŸtÄ±r (Run/Execute)

### Problem 3: Query hala yavaÅŸ

**Sebep:** Materialized view kullanÄ±lmÄ±yor

**Ã‡Ã¶zÃ¼m:**

1. LoglarÄ± kontrol et: `pm2 logs backend | grep "Materialized View"`
2. Entity filter var mÄ± kontrol et (alliance, corporation, character, ship)
3. Cache'i temizle: `pm2 restart backend`

### Problem 4: Refresh Ã§ok uzun sÃ¼rÃ¼yor

**Sebep:** Ã‡ok fazla yeni killmail

**Ã‡Ã¶zÃ¼m:**

1. CONCURRENT refresh kullanÄ±ldÄ±ÄŸÄ± iÃ§in queries bloklanmaz
2. Refresh interval'Ä± ayarla: `backend/src/services/materialized-view-refresh.ts` (5 dk â†’ 10 dk)

---

## ğŸ“Š Performance Metrics

### Ã–nceki Durum (Before)

```
âŒ Alliance filter query: HATA (Parameter limit exceeded)
âŒ Large result sets: Timeout
âŒ Multiple filters: 10-30 saniye
```

### Yeni Durum (After)

```
âœ… Alliance filter query: 500ms - 2s
âœ… Large result sets: 1-3s
âœ… Multiple filters: 500ms - 2s
âœ… Count queries: <100ms (cache from killmailIds.length)
```

### Expected Improvements

- âš¡ **50-99% faster** alliance/corporation queries
- âš¡ **No parameter limit errors**
- âš¡ **Consistent performance** regardless of result set size
- âš¡ **Better caching** with predictable query patterns

---

## ğŸ”™ Rollback Plan

EÄŸer bir sorun Ã§Ä±karsa:

### Option 1: Kod Rollback (Ã–nerilen)

```bash
cd /root/killreport
git log --oneline -5  # Son commit'i bul
git checkout <previous-commit-hash>
pm2 restart backend  # ts-node kullanÄ±yorsan build'e gerek yok
```

### Option 2: Migration Rollback

**âš ï¸ DÄ°KKAT:** Bu materialized view'Ä± silecek

**Backend sunucusunda:**

```bash
cd /root/killreport/backend

# Prisma ile rollback
npx prisma migrate resolve --rolled-back 20260215010000_add_killmail_filters_materialized_view
```

**Navicat SQL Console'da:**

```sql
-- Materialized view'Ä± sil (CASCADE: baÄŸlÄ± indexleri de siler)
DROP MATERIALIZED VIEW IF EXISTS killmail_filters_mv CASCADE;
```

Sonra eski kod versiyonunu deploy et.

---

## âœ… Post-Deployment Checklist

- [ ] Migration baÅŸarÄ±yla tamamlandÄ±
- [ ] Materialized view oluÅŸturuldu ve dolu
- [ ] Backend yeniden baÅŸlatÄ±ldÄ±
- [ ] PM2 logs temiz (error yok)
- [ ] Alliance filter query Ã§alÄ±ÅŸÄ±yor
- [ ] Response times beklenen seviyede (<2s)
- [ ] Frontend'de killmail listeleme Ã§alÄ±ÅŸÄ±yor
- [ ] 24 saat sonra performance metrics kontrol edildi
- [ ] Error tracking sisteminde yeni error yok (Sentry/LogRocket)

---

## ğŸ“ Support

Sorun Ã§Ä±karsa:

1. **PM2 Logs:** `pm2 logs backend --lines 200`
2. **PostgreSQL Logs:** `/var/log/postgresql/postgresql-*.log`
3. **Materialized View Status:** YukarÄ±daki kontrol script'lerini Ã§alÄ±ÅŸtÄ±r
4. **Rollback:** Gerekirse yukarÄ±daki rollback adÄ±mlarÄ±nÄ± uygula

---

## ğŸ“ˆ Long-term Maintenance

### 1. Materialized View Size Monitoring (HaftalÄ±k Kontrol)

**Navicat SQL Console'da Ã§alÄ±ÅŸtÄ±r:**

```sql
-- View boyut analizi
SELECT
  pg_size_pretty(pg_total_relation_size('killmail_filters_mv')) as total_size,
  pg_size_pretty(pg_relation_size('killmail_filters_mv')) as data_size,
  pg_size_pretty(pg_total_relation_size('killmail_filters_mv') - pg_relation_size('killmail_filters_mv')) as indexes_size;
```

### 2. Index Usage Review (AylÄ±k Kontrol)

**Navicat SQL Console'da Ã§alÄ±ÅŸtÄ±r:**

```sql
-- Index kullanÄ±m istatistikleri
SELECT
  indexname,
  idx_scan as scan_count,
  idx_tup_read,
  idx_tup_fetch,
  pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public' AND tablename = 'killmail_filters_mv'
ORDER BY idx_scan DESC;
```

âš ï¸ Ä°ndexler kullanÄ±lmÄ±yorsa (idx_scan = 0), drop edilebilir:

```sql
-- KullanÄ±lmayan index'i sil (Ã¶rnek)
-- DROP INDEX idx_kmfilters_constellation;  -- Sadece gerekirse!

### 3. Refresh Performance (On-going)

EÄŸer refresh 30 saniyeden fazla sÃ¼rerse, optimize et:

- Partial refresh stratejisi
- Incremental update
- Index tuning

---

## ğŸ¯ Success Criteria

Deployment baÅŸarÄ±lÄ±dÄ±r eÄŸer:

1. âœ… Alliance filter queries error vermeden Ã§alÄ±ÅŸÄ±yor
2. âœ… Response times < 2 saniye
3. âœ… Parameter limit errors yok
4. âœ… Materialized view refresh < 30 saniye
5. âœ… 7 gÃ¼n boyunca stability (no new errors)

---

**Prepared by:** GitHub Copilot
**Date:** February 15, 2026
**Version:** 1.0
```
